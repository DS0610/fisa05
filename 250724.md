# 250724 SQL
---
### 스토어드 프로시저(저장 프로시저)
- 자주 사용하는 여러개의 SQL문을 한데 묶어 함수처럼 만들어 일괄적으로 처리하는 용도로 사용
- 첫 행과 마지막 행에 구분문자라는 의미의 DELIMITER ~ DELIMITER 문으로 감싼 후 사이에 BEGIN과 END 사이에 SQL문을 넣으면 됨
- DELIMITER에는 $$ // && @@ 등의 부호를 구분문자로 많이 사용
- CALL 프로시저명(); 으로 위의 SQL 묶음을 호출
- 장점
    - 하나의 요청으로 여러 SQL문 실행 가능
    - 네트워크 소요 시간 줄일 수 있음

```
SHOW PROCEDURE STATUS; -- 프로시저 목록 확인
SHOW CREATE PROCEDURE 프로시저이름; -- 프로시저 내용 확인
DROP PROCEDURE 프로시저이름; -- 프로시저 삭제
```
#### 프로시저 안 IF문(IF~ELSE도 포함)
```
DELIMITER //
CREATE PROCEDURE 프로시저명
BEGIN
    DECLARE 열이름1 INT;
    SELECT COUNT(*) INTO 열이름1 FROM 테이블명 WHERE 조건1;
    IF 열이름1 > 조건2 THEN
        SELECT '원하는 출력 값' AS 별칭;
    ELSE
        SELECT '원하는 출력 값' AS 별칭;
    END IF;
END //
DELIMITER ;

select * from 테이블명;
call 프로시저명;
```
### 트리거(Trigger)
- 테이블에서 어떤 이벤트가 발생했을 때 자동으로 실행되는 것 -> 어떤 테이블에서 특정한 이벤트(update, insert, delete)가 발생했을 때, 실행시키고자 하는 추가 쿼리 작업들을 자동으로 수행할 수 있게끔 트리거를 미리 설정해 두는 것
- 직접 실행시킬 수 없고 오직 해당 테이블에 이벤트가 발생할 경우에만 실행
- DML에서만 작동되고, VIEW엔 사용 불가능
- TRUNCATE는 COMMIT까지 완료되므로 TRIGGER를 부착할 수 없음
```
DELIMITER $$

CREATE TRIGGER 트리거이름
    AFTER DELETE -- 트리거를 달 동작
    ON 테이블 FOR EACH ROW
BEGIN
    -- 문장
END $$    

DELIMITER ;
```

### 동적 SQL
- 상황에 따라 내용 변경이 필요할 때 사용
- PREPARE~EXCUTE가 대표적
    - PREPARE문에서는 ?로 향후 입력될 값을 비워놓고, EXCUTE문에서 USING으로 ?에 값을 전달
    - 실행 후에는 DEALLOCATE PREPARE로 문장을 해제해주는 것이 바람직
- 보안상 취약할 수 있으므로, 사용 전 반드시 적절한 검증과 예외 처리를 수행해야 함
```
DROP TABLE IF EXISTS gate_table;
CREATE TABLE gate_table (id INT AUTO_INCREMENT PRIMARY KEY, entry_time DATETIME);

SET @curDate = CURRENT_TIMESTAMP(); -- 현재 날짜와 시간

PREPARE myQuery FROM 'INSERT INTO gate_table VALUES(NULL, ?)';
EXECUTE myQuery USING @curDate;
DEALLOCATE PREPARE myQuery;

SELECT * FROM gate_table;



SET @count = 5;
PREPARE mySQL FROM 'SELECT code, name, continent, region, population
  FROM country
 WHERE population > 100000000
 ORDER BY 1 ASC
 LIMIT ?';
EXECUTE mySQL USING @count;
```